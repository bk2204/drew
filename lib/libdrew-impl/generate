#!/usr/bin/perl -w

use Getopt::Long;
use IO::File;
use IO::Handle;

$modules = 0;
$outputnm = undef;
$output = IO::Handle->new_from_fd(1, "w");
GetOptions("m" => \$modules,
		"modules" => \$modules,
		"o=s" => \$outputnm,
		"output=s" => \$outputnm);
$output = IO::File->new($outputnm, "w") if ($outputnm);

$output->print(<<EOM);
/* Do not edit this file.  It was autogenerated by libdrew-impl's generate. */

#include <internal.h>
#include <util.h>

HIDE()
EOM

if ($modules) {
	my @args = map { s/^.*\///; y/-/_/; s/^([a-z0-9_]+).*$/$1/; $_ } @ARGV;
	for my $i (@args) {
		$output->print("extern int drew_plugin_info_$i(void *, int, int, void *);\n");
	}
	$output->print("\nstatic const drew_plugin_api_t plugin_list[] = {\n");
	for my $i (@ARGV) {
		$output->print("\tdrew_plugin_info_$i,\n");
	}
	$output->print("};\n\n");
}
$output->print(<<EOM);
UNHIDE()
EOM
